generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Used for migrations (bypasses connection pooler)
}

// ============================================
// Enums
// ============================================

enum PartyType {
  VENDOR
  LABOUR
  SUBCONTRACTOR
  CLIENT
}

enum PaymentType {
  IN
  OUT
}

enum PaymentMode {
  CASH
  CHEQUE
  ONLINE
}

enum EntityType {
  EXPENSE
  PAYMENT
  DOCUMENT
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
}

enum ExpenseStatus {
  PENDING
  APPROVED
}

enum StageStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  BLOCKED
}

enum BOQCategory {
  MATERIAL
  LABOUR
  SUB_WORK
  EQUIPMENT
  OTHER
}

// ============================================
// Organizations & Users (Multi-tenant Foundation)
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  // Relations
  members        OrganizationMember[]
  projects       Project[]
  categoryItems  CategoryItem[]
  parties        Party[]
  expenses       Expense[]
  payments       Payment[]
  documents      Document[]
  stages         Stage[]
  tasks          Task[]
  attachments    Attachment[]
  roles          Role[]
  memberAdvances MemberAdvance[]
  boqSections    BOQSection[]
  boqItems       BOQItem[]

  @@map("organizations")
}

model User {
  id        String   @id @default(cuid())
  name      String
  phone     String?  @unique
  email     String?  @unique
  location  String?
  createdAt DateTime @default(now())

  // Relations
  memberships   OrganizationMember[]
  refreshTokens RefreshToken[]

  @@map("users")
}

// ============================================
// Roles & Permissions System
// ============================================

model Role {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  isSystemRole   Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions  RolePermission[]
  members      OrganizationMember[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  category    String
  createdAt   DateTime @default(now())

  // Relations
  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ============================================
// Authentication (OTP & Sessions)
// ============================================

model OtpVerification {
  id        String   @id @default(cuid())
  phone     String
  code      String   // hashed OTP
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, expiresAt])
  @@map("otp_verifications")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  roleId         String
  createdAt      DateTime @default(now())

  // Relations
  organization         Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                 User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role                 Role                      @relation(fields: [roleId], references: [id])
  projectAccess        ProjectAccess[]
  stageAssignments     StageMemberAssignment[]
  taskAssignments      TaskMemberAssignment[]
  recordedPayments     Payment[]                 @relation("PaymentRecordedBy")
  memberAdvances       MemberAdvance[]

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([roleId])
  @@map("organization_members")
}

// ============================================
// Project Access (Scoped Permissions)
// ============================================

model ProjectAccess {
  id        String   @id @default(cuid())
  memberId  String
  projectId String
  createdAt DateTime @default(now())

  // Relations
  member  OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  project Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([memberId, projectId])
  @@index([memberId])
  @@index([projectId])
  @@map("project_access")
}

// ============================================
// Categories System (Master Data)
// ============================================

// CategoryType is GLOBAL (not per-organization)
model CategoryType {
  id        String   @id @default(cuid())
  key       String   @unique // project_type | expense_type | material_type | labour_type | sub_work_type
  label     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items CategoryItem[]

  @@map("category_types")
}

// CategoryItem is per-organization
model CategoryItem {
  id             String   @id @default(cuid())
  organizationId String
  categoryTypeId String
  name           String
  isActive       Boolean  @default(true)
  isEditable     Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryType CategoryType @relation(fields: [categoryTypeId], references: [id], onDelete: Cascade)

  // Reverse relations for expenses
  projectsAsType     Project[] @relation("ProjectType")
  expensesAsType     Expense[] @relation("ExpenseType")
  expensesAsMaterial Expense[] @relation("MaterialType")
  expensesAsLabour   Expense[] @relation("LabourType")
  expensesAsSubWork  Expense[] @relation("SubWorkType")

  @@unique([organizationId, categoryTypeId, name])
  @@index([organizationId])
  @@index([categoryTypeId])
  @@map("category_items")
}

// ============================================
// Projects
// ============================================

model Project {
  id                String        @id @default(cuid())
  organizationId    String
  name              String
  clientId          String?
  location          String
  startDate         DateTime
  endDate           DateTime?
  amount            Decimal?      @db.Decimal(15, 2)
  projectTypeItemId String
  area              String?
  projectPicture    String?
  status            ProjectStatus @default(ACTIVE)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @default(now()) @updatedAt

  // Relations
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Party?          @relation("ProjectClient", fields: [clientId], references: [id])
  projectType    CategoryItem    @relation("ProjectType", fields: [projectTypeItemId], references: [id])
  stages         Stage[]
  expenses       Expense[]
  payments       Payment[]
  documents      Document[]
  projectAccess  ProjectAccess[]
  memberAdvances MemberAdvance[]
  boqSections    BOQSection[]
  boqItems       BOQItem[]

  @@index([organizationId])
  @@index([clientId])
  @@index([projectTypeItemId])
  @@index([status])
  @@map("projects")
}

// ============================================
// Stages
// ============================================

model Stage {
  id             String      @id @default(cuid())
  organizationId String
  projectId      String
  name           String
  description    String?
  startDate      DateTime
  endDate        DateTime
  budgetAmount   Decimal     @db.Decimal(15, 2)
  weight         Decimal     @db.Decimal(5, 2) // Contribution to overall project progress (%)
  status         StageStatus @default(SCHEDULED)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  organization      Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project           Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  expenses          Expense[]
  tasks             Task[]
  memberAssignments StageMemberAssignment[]
  partyAssignments  StagePartyAssignment[]
  boqItems          BOQItem[]

  @@unique([projectId, name])
  @@index([organizationId])
  @@index([projectId])
  @@index([status])
  @@map("stages")
}

// ============================================
// Stage Assignments (Junction Tables)
// ============================================

model StageMemberAssignment {
  id        String   @id @default(cuid())
  stageId   String
  memberId  String
  createdAt DateTime @default(now())

  // Relations
  stage  Stage              @relation(fields: [stageId], references: [id], onDelete: Cascade)
  member OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([stageId, memberId])
  @@index([stageId])
  @@index([memberId])
  @@map("stage_member_assignments")
}

model StagePartyAssignment {
  id        String   @id @default(cuid())
  stageId   String
  partyId   String
  createdAt DateTime @default(now())

  // Relations
  stage Stage @relation(fields: [stageId], references: [id], onDelete: Cascade)
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([stageId, partyId])
  @@index([stageId])
  @@index([partyId])
  @@map("stage_party_assignments")
}

// ============================================
// Tasks
// ============================================

model Task {
  id             String     @id @default(cuid())
  organizationId String
  stageId        String
  name           String
  description    String?
  daysAllocated  Int
  status         TaskStatus @default(NOT_STARTED)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  organization      Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stage             Stage                  @relation(fields: [stageId], references: [id], onDelete: Cascade)
  memberAssignments TaskMemberAssignment[]
  partyAssignments  TaskPartyAssignment[]

  @@index([organizationId])
  @@index([stageId])
  @@index([status])
  @@map("tasks")
}

// ============================================
// Task Assignments (Junction Tables)
// ============================================

model TaskMemberAssignment {
  id        String   @id @default(cuid())
  taskId    String
  memberId  String
  createdAt DateTime @default(now())

  // Relations
  task   Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  member OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([taskId, memberId])
  @@index([taskId])
  @@index([memberId])
  @@map("task_member_assignments")
}

model TaskPartyAssignment {
  id        String   @id @default(cuid())
  taskId    String
  partyId   String
  createdAt DateTime @default(now())

  // Relations
  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([taskId, partyId])
  @@index([taskId])
  @@index([partyId])
  @@map("task_party_assignments")
}

// ============================================
// Parties (External: Vendors, Labour, Subcontractors, Clients)
// ============================================

model Party {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  phone          String?
  location       String
  type           PartyType
  profilePicture String?
  createdAt      DateTime  @default(now())

  // Relations
  organization     Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expenses         Expense[]
  payments         Payment[]
  projectsAsClient Project[]              @relation("ProjectClient")
  stageAssignments StagePartyAssignment[]
  taskAssignments  TaskPartyAssignment[]

  @@index([organizationId])
  @@index([type])
  @@map("parties")
}

// ============================================
// Expenses
// ============================================

model Expense {
  id                 String        @id @default(cuid())
  organizationId     String
  projectId          String
  partyId            String
  stageId            String?
  expenseTypeItemId  String
  materialTypeItemId String?
  labourTypeItemId   String?
  subWorkTypeItemId  String?
  description        String?
  rate               Decimal       @db.Decimal(15, 2)
  quantity           Decimal       @db.Decimal(15, 4)
  expenseDate        DateTime
  status             ExpenseStatus @default(PENDING)
  notes              String?       @db.Text
  createdAt          DateTime      @default(now())

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  party        Party         @relation(fields: [partyId], references: [id])
  stage        Stage?        @relation(fields: [stageId], references: [id])
  expenseType  CategoryItem  @relation("ExpenseType", fields: [expenseTypeItemId], references: [id])
  materialType CategoryItem? @relation("MaterialType", fields: [materialTypeItemId], references: [id])
  labourType   CategoryItem? @relation("LabourType", fields: [labourTypeItemId], references: [id])
  subWorkType  CategoryItem? @relation("SubWorkType", fields: [subWorkTypeItemId], references: [id])
  payments     Payment[]
  boqLinks     BOQExpenseLink[]

  @@index([organizationId])
  @@index([projectId])
  @@index([partyId])
  @@index([stageId])
  @@index([expenseDate])
  @@map("expenses")
}

// ============================================
// Payments
// ============================================

model Payment {
  id              String      @id @default(cuid())
  organizationId  String
  projectId       String
  partyId         String?
  expenseId       String?
  recordedById    String?
  type            PaymentType
  paymentMode     PaymentMode
  amount          Decimal     @db.Decimal(15, 2)
  paymentDate     DateTime
  referenceNumber String?     // Invoice/Receipt number
  notes           String?     @db.Text
  createdAt       DateTime    @default(now())

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  party        Party?              @relation(fields: [partyId], references: [id])
  expense      Expense?            @relation(fields: [expenseId], references: [id])
  recordedBy   OrganizationMember? @relation("PaymentRecordedBy", fields: [recordedById], references: [id])

  @@index([organizationId])
  @@index([projectId])
  @@index([partyId])
  @@index([expenseId])
  @@index([recordedById])
  @@index([paymentDate])
  @@index([type])
  @@map("payments")
}

// ============================================
// Documents
// ============================================

model Document {
  id             String   @id @default(cuid())
  organizationId String
  projectId      String
  fileName       String
  fileType       String
  fileUrl        String
  storagePath    String
  mimeType       String
  uploadedAt     DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([projectId])
  @@map("documents")
}

// ============================================
// Attachments (Unified file storage)
// ============================================

model Attachment {
  id             String   @id @default(cuid())
  organizationId String
  fileName       String
  fileUrl        String
  storagePath    String
  mimeType       String
  uploadedAt     DateTime @default(now())

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entities     EntityAttachment[]

  @@index([organizationId])
  @@map("attachments")
}

// ============================================
// Entity Attachments (Junction table)
// ============================================

model EntityAttachment {
  id           String     @id @default(cuid())
  attachmentId String
  entityType   EntityType
  entityId     String
  createdAt    DateTime   @default(now())

  // Relations
  attachment Attachment @relation(fields: [attachmentId], references: [id], onDelete: Cascade)

  @@unique([attachmentId, entityType, entityId])
  @@index([entityType, entityId])
  @@map("entity_attachments")
}

// ============================================
// Member Advances (Cash advances to team members)
// ============================================

model MemberAdvance {
  id                     String      @id @default(cuid())
  organizationId         String
  projectId              String
  memberId               String
  amount                 Decimal     @db.Decimal(15, 2)
  purpose                String
  paymentMode            PaymentMode
  advanceDate            DateTime
  expectedSettlementDate DateTime?
  notes                  String?     @db.Text
  createdAt              DateTime    @default(now())

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  member       OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([projectId])
  @@index([memberId])
  @@index([advanceDate])
  @@map("member_advances")
}

// ============================================
// BOQ (Bill of Quantities)
// ============================================

model BOQSection {
  id             String   @id @default(cuid())
  organizationId String
  projectId      String
  name           String
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items        BOQItem[]

  @@unique([projectId, name])
  @@index([organizationId])
  @@index([projectId])
  @@map("boq_sections")
}

model BOQItem {
  id              String      @id @default(cuid())
  organizationId  String
  projectId       String
  sectionId       String?
  stageId         String?
  code            String?     // e.g., "R2-CS-EW-1"
  category        BOQCategory
  description     String
  unit            String
  quantity        Decimal     @db.Decimal(15, 4)
  rate            Decimal     @db.Decimal(15, 2)
  notes           String?     @db.Text
  isReviewFlagged Boolean     @default(false)
  flagReason      String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  section      BOQSection?      @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  stage        Stage?           @relation(fields: [stageId], references: [id], onDelete: SetNull)
  expenseLinks BOQExpenseLink[]

  @@index([organizationId])
  @@index([projectId])
  @@index([sectionId])
  @@index([stageId])
  @@index([category])
  @@map("boq_items")
}

model BOQExpenseLink {
  id        String   @id @default(cuid())
  boqItemId String
  expenseId String
  createdAt DateTime @default(now())

  // Relations
  boqItem BOQItem @relation(fields: [boqItemId], references: [id], onDelete: Cascade)
  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@unique([boqItemId, expenseId])
  @@index([boqItemId])
  @@index([expenseId])
  @@map("boq_expense_links")
}
