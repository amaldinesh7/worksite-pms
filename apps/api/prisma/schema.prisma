generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

enum OrganizationRole {
  ADMIN      // Full access to everything
  MANAGER    // Manage projects, parties, expenses, payments
  ACCOUNTANT // View/manage expenses and payments only
  SUPERVISOR // View assigned projects, add expenses
  CLIENT     // View their project progress and payments
}

enum PartyType {
  VENDOR
  LABOUR
  SUBCONTRACTOR
  CLIENT
  ACCOUNTANT
  SUPERVISOR
  PROJECT_MANAGER
}

enum PaymentType {
  IN
  OUT
}

enum PaymentMode {
  CASH
  CHEQUE
  ONLINE
}

enum EntityType {
  EXPENSE
  PAYMENT
  DOCUMENT
}

// ============================================
// Organizations & Users (Multi-tenant Foundation)
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  // Relations
  members        OrganizationMember[]
  projects       Project[]
  categoryTypes  CategoryType[]
  categoryItems  CategoryItem[]
  parties        Party[]
  expenses       Expense[]
  payments       Payment[]
  documents      Document[]
  stages         Stage[]
  attachments    Attachment[]

  @@map("organizations")
}

model User {
  id        String   @id @default(cuid())
  name      String
  phone     String?  @unique
  email     String?  @unique
  createdAt DateTime @default(now())

  // Relations
  memberships   OrganizationMember[]
  refreshTokens RefreshToken[]
  party         Party?

  @@map("users")
}

// ============================================
// Authentication (OTP & Sessions)
// ============================================

model OtpVerification {
  id        String   @id @default(cuid())
  phone     String
  code      String   // hashed OTP
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, expiresAt])
  @@map("otp_verifications")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model OrganizationMember {
  id             String           @id @default(cuid())
  organizationId String
  userId         String
  role           OrganizationRole
  createdAt      DateTime         @default(now())

  // Relations
  organization  Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectAccess ProjectAccess[]

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

// ============================================
// Project Access (Scoped Permissions)
// ============================================

model ProjectAccess {
  id        String   @id @default(cuid())
  memberId  String
  projectId String
  createdAt DateTime @default(now())

  // Relations
  member  OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  project Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([memberId, projectId])
  @@index([memberId])
  @@index([projectId])
  @@map("project_access")
}

// ============================================
// Categories System (Master Data)
// ============================================

model CategoryType {
  id             String   @id @default(cuid())
  organizationId String
  key            String   // project_type | expense_category | material_type | labour_type | sub_work_type
  label          String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items        CategoryItem[]

  @@unique([organizationId, key])
  @@index([organizationId])
  @@map("category_types")
}

model CategoryItem {
  id             String   @id @default(cuid())
  organizationId String
  categoryTypeId String
  name           String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryType CategoryType @relation(fields: [categoryTypeId], references: [id], onDelete: Cascade)

  // Reverse relations for expenses
  projectsAsType        Project[]  @relation("ProjectType")
  expensesAsCategory    Expense[]  @relation("ExpenseCategory")
  expensesAsMaterial    Expense[]  @relation("MaterialType")
  expensesAsLabour      Expense[]  @relation("LabourType")
  expensesAsSubWork     Expense[]  @relation("SubWorkType")

  @@unique([categoryTypeId, name])
  @@index([organizationId])
  @@index([categoryTypeId])
  @@map("category_items")
}

// ============================================
// Projects
// ============================================

model Project {
  id                String   @id @default(cuid())
  organizationId    String
  name              String
  clientId          String?
  location          String
  startDate         DateTime
  amount            Decimal? @db.Decimal(15, 2)
  projectTypeItemId String
  createdAt         DateTime @default(now())

  // Relations
  organization  Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client        Party?          @relation("ProjectClient", fields: [clientId], references: [id])
  projectType   CategoryItem    @relation("ProjectType", fields: [projectTypeItemId], references: [id])
  stages        Stage[]
  expenses      Expense[]
  payments      Payment[]
  documents     Document[]
  projectAccess ProjectAccess[]

  @@index([organizationId])
  @@index([clientId])
  @@index([projectTypeItemId])
  @@map("projects")
}

// ============================================
// Stages
// ============================================

model Stage {
  id             String   @id @default(cuid())
  organizationId String
  projectId      String
  name           String
  budgetAmount   Decimal  @db.Decimal(15, 2)
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  expenses     Expense[]

  @@unique([projectId, name])
  @@index([organizationId])
  @@index([projectId])
  @@map("stages")
}

// ============================================
// Parties
// ============================================

model Party {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  phone          String?
  location       String
  type           PartyType
  isInternal     Boolean   @default(false)
  profilePicture String?
  userId         String?   @unique
  createdAt      DateTime  @default(now())

  // Relations
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user             User?        @relation(fields: [userId], references: [id])
  expenses         Expense[]
  payments         Payment[]
  projectsAsClient Project[]    @relation("ProjectClient")

  @@index([organizationId])
  @@index([type])
  @@index([isInternal])
  @@index([userId])
  @@map("parties")
}

// ============================================
// Expenses
// ============================================

model Expense {
  id                    String   @id @default(cuid())
  organizationId        String
  projectId             String
  partyId               String
  stageId               String?
  expenseCategoryItemId String
  materialTypeItemId    String?
  labourTypeItemId      String?
  subWorkTypeItemId     String?
  rate                  Decimal  @db.Decimal(15, 2)
  quantity              Decimal  @db.Decimal(15, 4)
  expenseDate           DateTime
  notes                 String?  @db.Text
  createdAt             DateTime @default(now())

  // Relations
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  party           Party         @relation(fields: [partyId], references: [id])
  stage           Stage?        @relation(fields: [stageId], references: [id])
  expenseCategory CategoryItem  @relation("ExpenseCategory", fields: [expenseCategoryItemId], references: [id])
  materialType    CategoryItem? @relation("MaterialType", fields: [materialTypeItemId], references: [id])
  labourType      CategoryItem? @relation("LabourType", fields: [labourTypeItemId], references: [id])
  subWorkType     CategoryItem? @relation("SubWorkType", fields: [subWorkTypeItemId], references: [id])
  payments        Payment[]

  @@index([organizationId])
  @@index([projectId])
  @@index([partyId])
  @@index([stageId])
  @@index([expenseDate])
  @@map("expenses")
}

// ============================================
// Payments
// ============================================

model Payment {
  id             String      @id @default(cuid())
  organizationId String
  projectId      String
  partyId        String?
  expenseId      String?
  type           PaymentType
  paymentMode    PaymentMode
  amount         Decimal     @db.Decimal(15, 2)
  paymentDate    DateTime
  notes          String?     @db.Text
  createdAt      DateTime    @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  party        Party?       @relation(fields: [partyId], references: [id])
  expense      Expense?     @relation(fields: [expenseId], references: [id])

  @@index([organizationId])
  @@index([projectId])
  @@index([partyId])
  @@index([expenseId])
  @@index([paymentDate])
  @@index([type])
  @@map("payments")
}

// ============================================
// Documents
// ============================================

model Document {
  id             String   @id @default(cuid())
  organizationId String
  projectId      String
  fileName       String
  fileType       String
  fileUrl        String
  storagePath    String
  mimeType       String
  uploadedAt     DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([projectId])
  @@map("documents")
}

// ============================================
// Attachments (Unified file storage)
// ============================================

model Attachment {
  id             String   @id @default(cuid())
  organizationId String
  fileName       String
  fileUrl        String
  storagePath    String
  mimeType       String
  uploadedAt     DateTime @default(now())

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entities     EntityAttachment[]

  @@index([organizationId])
  @@map("attachments")
}

// ============================================
// Entity Attachments (Junction table)
// ============================================

model EntityAttachment {
  id           String     @id @default(cuid())
  attachmentId String
  entityType   EntityType
  entityId     String
  createdAt    DateTime   @default(now())

  // Relations
  attachment Attachment @relation(fields: [attachmentId], references: [id], onDelete: Cascade)

  @@unique([attachmentId, entityType, entityId])
  @@index([entityType, entityId])
  @@map("entity_attachments")
}
